<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0f1117">
<meta name="description" content="Private custody incident documentation log">
<link rel="manifest" href="manifest.json">
<link rel="icon" type="image/png" href="icon-192.png">
<link rel="apple-touch-icon" href="icon-192.png">
<title>CustodyLog</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap');
:root {
  --bg:#0f1117;--s1:#1a1d27;--s2:#232733;--s3:#2a2e3b;
  --bdr:#2d3140;--tx:#e8e9ed;--tx2:#c0c3cf;--mt:#6b7089;
  --ac:#4a9eff;--acd:rgba(74,158,255,.12);--acb:rgba(74,158,255,.3);
  --rd:#ff6b6b;--rdd:rgba(255,107,107,.12);--rdb:rgba(255,107,107,.3);
  --gn:#51cf96;--gnd:rgba(81,207,150,.12);
  --yw:#ffc145;--ywd:rgba(255,193,69,.12);--ywb:rgba(255,193,69,.3);
  --r:12px;--rs:8px;
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{font-family:'DM Sans',-apple-system,BlinkMacSystemFont,sans-serif;background:var(--bg);color:var(--tx);min-height:100vh;min-height:100dvh;overflow-x:hidden;-webkit-font-smoothing:antialiased}
input,textarea,select,button{font-family:inherit}

/* â•â• Animations â•â• */
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes slideRight{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
@keyframes slideLeft{from{transform:translateX(-100%);opacity:0}to{transform:translateX(0);opacity:1}}
@keyframes slideUp{from{transform:translateY(16px);opacity:0}to{transform:translateY(0);opacity:1}}
@keyframes shake{0%,100%{transform:translateX(0)}20%,60%{transform:translateX(-8px)}40%,80%{transform:translateX(8px)}}
.fadeIn{animation:fadeIn .25s ease}
.slideRight{animation:slideRight .3s ease}
.slideLeft{animation:slideLeft .3s ease}
.slideUp{animation:slideUp .25s ease}
.shake{animation:shake .4s ease}

/* â•â• PIN Screen â•â• */
.pin-wrap{min-height:100vh;min-height:100dvh;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:40px 24px;text-align:center}
.pin-logo{font-size:56px;margin-bottom:16px}
.pin-wrap h1{font-size:22px;font-weight:700;margin-bottom:6px}
.pin-wrap .sub{color:var(--mt);font-size:14px;margin-bottom:32px;max-width:260px}
.pin-dots{display:flex;gap:12px;margin-bottom:32px;justify-content:center}
.pin-dot{width:16px;height:16px;border-radius:50%;border:2px solid var(--bdr);background:transparent;transition:all .15s}
.pin-dot.filled{background:var(--ac);border-color:var(--ac)}
.pin-dot.error{background:var(--rd);border-color:var(--rd)}
.pin-pad{display:grid;grid-template-columns:repeat(3,72px);gap:12px;justify-content:center}
.pin-key{width:72px;height:72px;border-radius:50%;border:1px solid var(--bdr);background:var(--s1);color:var(--tx);font-size:24px;font-weight:600;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .1s;-webkit-user-select:none;user-select:none}
.pin-key:active{background:var(--s3);transform:scale(.93)}
.pin-key.empty{border:none;background:transparent}
.pin-key.fn{font-size:14px;color:var(--mt);border:none;background:transparent}
.pin-key.fn:active{color:var(--tx)}
.pin-msg{margin-top:16px;font-size:13px;color:var(--rd);min-height:20px}
.pin-skip{margin-top:20px;color:var(--mt);font-size:13px;background:none;border:none;cursor:pointer;text-decoration:underline}

/* â•â• App Shell â•â• */
.header{position:sticky;top:0;z-index:100;background:rgba(15,17,23,.88);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border-bottom:1px solid var(--bdr);padding:14px 20px;display:flex;align-items:center;justify-content:space-between}
.header h1{font-size:17px;font-weight:700;display:flex;align-items:center;gap:8px}
.header h1 span{font-size:20px}
.hdr-btns{display:flex;gap:8px}
.ibtn{width:38px;height:38px;border-radius:var(--rs);border:1px solid var(--bdr);background:var(--s1);color:var(--mt);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:16px;transition:all .15s}
.ibtn:active{transform:scale(.93);background:var(--s2)}

.tabs{display:flex;gap:4px;padding:10px 20px;background:var(--bg);border-bottom:1px solid var(--bdr);position:sticky;top:67px;z-index:99}
.tab{flex:1;padding:10px 4px;border-radius:var(--rs);border:none;background:transparent;color:var(--mt);font-size:13px;font-weight:600;cursor:pointer;transition:all .15s;text-align:center}
.tab.on{background:var(--acd);color:var(--ac)}
.tab:active{transform:scale(.97)}

.content{padding:16px 20px 120px}

/* â•â• Category Selection Page â•â• */
.grp-label{font-size:11px;font-weight:700;letter-spacing:1.2px;text-transform:uppercase;color:var(--mt);margin:18px 0 8px;display:flex;align-items:center;gap:6px}
.grp-label:first-child{margin-top:4px}
.cat-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.cat-btn{padding:14px 12px;border-radius:var(--r);border:1px solid var(--bdr);background:var(--s1);color:var(--tx);font-size:13px;font-weight:500;cursor:pointer;transition:all .15s;display:flex;align-items:center;gap:9px;text-align:left;line-height:1.3}
.cat-btn .ci{font-size:20px;flex-shrink:0}
.cat-btn:active{transform:scale(.97);background:var(--s2)}

/* â•â• Detail Form Page â•â• */
.form-page{max-width:500px;margin:0 auto}
.back-bar{display:flex;align-items:center;gap:10px;padding:4px 0 16px;cursor:pointer}
.back-bar .arrow{font-size:20px;color:var(--ac)}
.back-bar .cat-tag{font-size:14px;font-weight:600;display:flex;align-items:center;gap:6px}
.flabel{display:block;font-size:11px;font-weight:700;color:var(--mt);margin-bottom:6px;text-transform:uppercase;letter-spacing:.8px}
.fgroup{margin-bottom:16px}
.finput,.ftextarea,.fselect{width:100%;padding:13px 15px;border-radius:var(--r);border:1px solid var(--bdr);background:var(--s1);color:var(--tx);font-size:16px;outline:none;transition:border-color .15s;-webkit-appearance:none}
.finput:focus,.ftextarea:focus{border-color:var(--ac)}
.ftextarea{min-height:130px;resize:vertical;line-height:1.5;font-size:15px}
.finput::placeholder,.ftextarea::placeholder{color:var(--mt);opacity:.5}
input[type="date"],input[type="time"]{color-scheme:dark}
.row{display:flex;gap:8px}
.row>*{flex:1}

.sev-row{display:flex;gap:7px}
.sev-btn{flex:1;padding:10px 4px;border-radius:var(--rs);border:1px solid var(--bdr);background:var(--s1);font-size:12px;font-weight:600;cursor:pointer;text-align:center;transition:all .15s;color:var(--mt)}
.sev-btn:active{transform:scale(.96)}
.sev-btn.s-low{border-color:var(--gn);color:var(--gn);background:var(--gnd)}
.sev-btn.s-medium{border-color:var(--yw);color:var(--yw);background:var(--ywd)}
.sev-btn.s-high{border-color:var(--rd);color:var(--rd);background:var(--rdd)}
.sev-btn.s-critical{border-color:#ff3b3b;color:#ff3b3b;background:rgba(255,59,59,.15)}

.chk-row{display:flex;align-items:center;gap:10px;padding:12px 0;cursor:pointer;-webkit-user-select:none;user-select:none}
.chk-row input{width:22px;height:22px;accent-color:var(--ac);cursor:pointer;flex-shrink:0}
.chk-row label{font-size:14px;cursor:pointer}

/* â•â• Media Attachments â•â• */
.media-section{margin-bottom:16px}
.media-btns{display:flex;gap:8px;flex-wrap:wrap}
.media-btn{padding:10px 16px;border-radius:var(--r);border:1px solid var(--bdr);background:var(--s1);color:var(--tx2);font-size:13px;font-weight:500;cursor:pointer;display:flex;align-items:center;gap:6px;transition:all .15s}
.media-btn:active{transform:scale(.96);background:var(--s2)}
.media-btn .mi{font-size:18px}
.media-list{margin-top:10px;display:flex;flex-direction:column;gap:8px}
.media-item{display:flex;align-items:center;gap:10px;padding:10px 12px;background:var(--s2);border-radius:var(--rs);border:1px solid var(--bdr)}
.media-item .mthumb{width:48px;height:48px;border-radius:6px;object-fit:cover;background:var(--s3);flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:22px;overflow:hidden}
.media-item .mthumb img{width:100%;height:100%;object-fit:cover}
.media-item .minfo{flex:1;min-width:0}
.media-item .mname{font-size:13px;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.media-item .msize{font-size:11px;color:var(--mt)}
.media-item .mrem{width:32px;height:32px;border-radius:50%;border:none;background:var(--rdd);color:var(--rd);font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.media-item .mrem:active{transform:scale(.9)}

/* â•â• Primary / Secondary Buttons â•â• */
.pbtn{width:100%;padding:16px;border-radius:var(--r);border:none;background:var(--ac);color:#fff;font-size:16px;font-weight:700;cursor:pointer;transition:all .15s;letter-spacing:.3px}
.pbtn:active{transform:scale(.98);opacity:.9}
.pbtn:disabled{opacity:.35;cursor:not-allowed}
.sbtn{width:100%;padding:14px;border-radius:var(--r);border:1px solid var(--bdr);background:var(--s1);color:var(--tx);font-size:15px;font-weight:600;cursor:pointer;margin-top:10px;transition:all .15s}
.sbtn:active{transform:scale(.98)}

/* â•â• Log Entries â•â• */
.ecard{background:var(--s1);border:1px solid var(--bdr);border-radius:var(--r);padding:14px 16px;margin-bottom:10px;cursor:pointer;transition:all .15s;animation:slideUp .25s ease}
.ecard:active{background:var(--s2)}
.ehead{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:6px}
.ecat{font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:.6px;display:flex;align-items:center;gap:5px}
.esev{font-size:10px;font-weight:700;padding:3px 8px;border-radius:20px;text-transform:uppercase;letter-spacing:.7px}
.esev.sev-low{background:var(--gnd);color:var(--gn)}
.esev.sev-medium{background:var(--ywd);color:var(--yw)}
.esev.sev-high{background:var(--rdd);color:var(--rd)}
.esev.sev-critical{background:rgba(255,59,59,.18);color:#ff3b3b}
.edesc{font-size:14px;line-height:1.5;margin-bottom:8px;white-space:pre-wrap;word-break:break-word;color:var(--tx2)}
.emeta{display:flex;flex-wrap:wrap;gap:10px;font-size:12px;color:var(--mt)}
.emeta span{display:flex;align-items:center;gap:3px}
.ebadges{display:flex;gap:5px;margin-top:7px;flex-wrap:wrap}
.badge{font-size:10px;font-weight:600;padding:3px 8px;border-radius:20px;text-transform:uppercase;letter-spacing:.4px}
.badge-ac{background:var(--acd);color:var(--ac)}
.badge-rd{background:var(--rdd);color:var(--rd)}
.badge-gn{background:var(--gnd);color:var(--gn)}

/* â•â• Search & Filters â•â• */
.search-bar{position:relative;margin-bottom:12px}
.search-bar input{width:100%;padding:12px 16px 12px 40px;border-radius:var(--r);border:1px solid var(--bdr);background:var(--s1);color:var(--tx);font-size:15px;outline:none}
.search-bar input:focus{border-color:var(--ac)}
.search-bar .si{position:absolute;left:13px;top:50%;transform:translateY(-50%);color:var(--mt);font-size:16px}
.fbar{display:flex;gap:7px;margin-bottom:14px;overflow-x:auto;padding-bottom:4px;-webkit-overflow-scrolling:touch}
.fbar::-webkit-scrollbar{display:none}
.fchip{flex-shrink:0;padding:7px 13px;border-radius:20px;border:1px solid var(--bdr);background:var(--s1);color:var(--mt);font-size:12px;font-weight:600;cursor:pointer;transition:all .15s;white-space:nowrap}
.fchip.on{border-color:var(--acb);color:var(--ac);background:var(--acd)}
.fchip:active{transform:scale(.95)}

/* â•â• Empty State â•â• */
.empty{text-align:center;padding:60px 20px;color:var(--mt)}
.empty .ei{font-size:48px;margin-bottom:16px;opacity:.4}
.empty h3{font-size:16px;margin-bottom:8px;color:var(--tx)}
.empty p{font-size:14px;line-height:1.5;max-width:280px;margin:0 auto}

/* â•â• Export â•â• */
.stats{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px}
.stat{background:var(--s1);border:1px solid var(--bdr);border-radius:var(--r);padding:16px;text-align:center}
.stat .num{font-size:28px;font-weight:700;margin-bottom:4px}
.stat .lbl{font-size:11px;color:var(--mt);text-transform:uppercase;letter-spacing:1px;font-weight:600}
.xcard{background:var(--s1);border:1px solid var(--bdr);border-radius:var(--r);padding:16px;margin-bottom:10px;cursor:pointer;transition:all .15s;display:flex;align-items:center;gap:14px}
.xcard:active{background:var(--s2);transform:scale(.99)}
.xcard .xi{font-size:28px}
.xcard h3{font-size:15px;font-weight:600;margin-bottom:2px}
.xcard p{font-size:13px;color:var(--mt)}
.disclaimer{margin-top:24px;padding:16px;background:var(--s1);border:1px solid var(--bdr);border-radius:var(--r);font-size:12px;color:var(--mt);line-height:1.6}
.disclaimer strong{color:var(--yw)}

/* â•â• Detail Modal â•â• */
.modal-bg{position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:200;display:flex;align-items:flex-end;justify-content:center;opacity:0;pointer-events:none;transition:opacity .2s}
.modal-bg.open{opacity:1;pointer-events:all}
.modal{background:var(--s1);border-radius:20px 20px 0 0;width:100%;max-width:500px;max-height:85vh;overflow-y:auto;padding:20px 20px calc(20px + env(safe-area-inset-bottom,0px));transform:translateY(100%);transition:transform .3s ease}
.modal-bg.open .modal{transform:translateY(0)}
.modal-handle{width:36px;height:4px;background:var(--bdr);border-radius:2px;margin:0 auto 16px}
.modal h2{font-size:18px;margin-bottom:16px;display:flex;align-items:center;gap:8px}
.detail-row{margin-bottom:14px}
.detail-row .dl{font-size:11px;font-weight:700;color:var(--mt);text-transform:uppercase;letter-spacing:.8px;margin-bottom:4px}
.detail-row .dv{font-size:14px;line-height:1.6;white-space:pre-wrap}
.modal-media{display:flex;gap:8px;flex-wrap:wrap;margin-top:4px}
.modal-media .mm{width:72px;height:72px;border-radius:8px;overflow:hidden;background:var(--s3);cursor:pointer;display:flex;align-items:center;justify-content:center}
.modal-media .mm img{width:100%;height:100%;object-fit:cover}
.modal-media .mm video{width:100%;height:100%;object-fit:cover}
.modal-media .mm-audio{width:100%;padding:8px;font-size:11px;color:var(--ac);text-align:center}
.modal-actions{display:flex;gap:8px;margin-top:20px}
.modal-actions .sbtn{margin:0;flex:1}
.dbtn{flex:.6;padding:14px;border-radius:var(--r);border:1px solid var(--rdb);background:var(--rdd);color:var(--rd);font-size:13px;font-weight:600;cursor:pointer}
.dbtn:active{transform:scale(.95)}
.detail-id{font-size:11px;color:var(--mt);font-family:monospace;margin-top:12px}

/* â•â• Notification Banner â•â• */
.note{padding:12px 16px;border-radius:var(--r);margin-bottom:14px;font-size:13px;line-height:1.5;display:flex;gap:10px;align-items:flex-start}
.note .ni{font-size:18px;flex-shrink:0}
.note-info{background:var(--acd);border:1px solid var(--acb);color:var(--ac)}
.note-warn{background:var(--ywd);border:1px solid var(--ywb);color:var(--yw)}

/* â•â• Toast â•â• */
.toast{position:fixed;bottom:90px;left:50%;transform:translateX(-50%) translateY(20px);background:var(--gn);color:#fff;padding:12px 24px;border-radius:var(--r);font-size:14px;font-weight:600;z-index:300;opacity:0;transition:all .3s;pointer-events:none;white-space:nowrap}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

/* â•â• Responsive â•â• */
@media(min-width:500px){.cat-grid{grid-template-columns:1fr 1fr 1fr}.content,.header,.tabs{max-width:500px;margin-left:auto;margin-right:auto}}
</style>
</head>
<body>

<div id="app"></div>
<div class="toast" id="toast"></div>

<!-- Hidden file inputs -->
<input type="file" id="photoInput" accept="image/*" capture="environment" style="display:none">
<input type="file" id="videoInput" accept="video/*" capture="environment" style="display:none">
<input type="file" id="audioInput" accept="audio/*" capture="microphone" style="display:none">
<input type="file" id="fileInput" accept="image/*,video/*,audio/*" style="display:none">
<input type="file" id="importInput" accept=".json" style="display:none">

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CustodyLog v2 â€” Private Incident Documentation
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const CATS = [
  { id:'emotional',    icon:'ğŸ”´', label:'Emotional Outburst',     g:'behavior' },
  { id:'threat',       icon:'âš ï¸', label:'Threats / Intimidation', g:'behavior' },
  { id:'exchange',     icon:'ğŸ”„', label:'Custody Exchange Issue',  g:'custody' },
  { id:'violation',    icon:'âš–ï¸', label:'Court Order Violation',  g:'custody' },
  { id:'communication',icon:'ğŸ’¬', label:'Hostile Communication',  g:'comms' },
  { id:'accusation',   icon:'ğŸš¨', label:'False Accusation',       g:'comms' },
  { id:'boundary',     icon:'ğŸš§', label:'Boundary Violation',     g:'comms' },
  { id:'alienation',   icon:'ğŸ’”', label:'Alienation Behavior',    g:'children' },
  { id:'wellbeing',    icon:'ğŸ‘¶', label:"Children's Wellbeing",   g:'children' },
  { id:'neglect',      icon:'ğŸ ', label:'Neglect / Safety',       g:'children' },
  { id:'substance',    icon:'ğŸ·', label:'Substance Abuse',        g:'concern' },
  { id:'financial',    icon:'ğŸ’°', label:'Financial Issue',         g:'concern' },
  { id:'harassment',   icon:'ğŸ“µ', label:'Harassment / Stalking',  g:'concern' },
  { id:'witness',      icon:'ğŸ‘ï¸', label:'Witness Observation',    g:'docs' },
  { id:'positive',     icon:'âœ…', label:'Positive Interaction',   g:'docs' },
  { id:'other',        icon:'ğŸ“', label:'Other / General Note',   g:'docs' },
];

const GROUPS = {
  behavior:'ğŸ”´ Behavior & Safety',
  custody:'âš–ï¸ Custody & Court',
  comms:'ğŸ’¬ Communication',
  children:'ğŸ‘¶ Children',
  concern:'âš ï¸ Concerns',
  docs:'ğŸ“‹ Documentation'
};

const SEVS = [
  {id:'low',label:'Low',cls:'s-low'},
  {id:'medium',label:'Medium',cls:'s-medium'},
  {id:'high',label:'High',cls:'s-high'},
  {id:'critical',label:'Critical',cls:'s-critical'},
];

// â”€â”€ Storage â”€â”€
const LS = {
  entries: () => { try { return JSON.parse(localStorage.getItem('cl_entries')||'[]'); } catch { return []; } },
  save: (e) => localStorage.setItem('cl_entries', JSON.stringify(e)),
  pin: () => localStorage.getItem('cl_pin'),
  setPin: (p) => localStorage.setItem('cl_pin', p),
  rmPin: () => localStorage.removeItem('cl_pin'),
  seen: () => localStorage.getItem('cl_seen') === '1',
  setSeen: () => localStorage.setItem('cl_seen', '1'),
};

// â”€â”€ State â”€â”€
let S = {
  // auth
  screen: 'boot', // boot|pin_create|pin_enter|app
  pinDigits: [],
  pinPhase: 'first', // first|confirm
  pinFirst: [],
  pinError: '',
  pinLocked: false,

  // app
  tab: 'new', // new|log|export
  page: 'categories', // categories|form
  
  // form
  cat: '',
  severity: 'medium',
  desc: '',
  date: '',
  time: '',
  location: '',
  witnesses: '',
  kidsThere: false,
  kidsNames: '',
  media: [], // [{name,type,size,data}]
  editId: null,

  // log
  filter: 'all',
  search: '',

  // modal
  viewing: null,

  // data
  entries: LS.entries(),
};

// â”€â”€ Init â”€â”€
function boot() {
  const pin = LS.pin();
  if (pin) {
    S.screen = 'pin_enter';
  } else if (!LS.seen()) {
    S.screen = 'pin_create';
  } else {
    S.screen = 'app';
  }
  render();
}

// â”€â”€ Render â”€â”€
function render() {
  const app = document.getElementById('app');
  if (S.screen === 'pin_create') { app.innerHTML = pinCreateHTML(); return; }
  if (S.screen === 'pin_enter')  { app.innerHTML = pinEnterHTML();  return; }
  app.innerHTML = appHTML();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PIN SCREENS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function pinCreateHTML() {
  const title = S.pinPhase === 'first' ? 'Create a PIN' : 'Confirm Your PIN';
  const sub = S.pinPhase === 'first'
    ? 'Choose a 4-digit PIN to protect your entries.'
    : 'Enter your PIN again to confirm.';
  return `<div class="pin-wrap fadeIn">
    <div class="pin-logo">ğŸ›¡ï¸</div>
    <h1>${title}</h1>
    <p class="sub">${sub}</p>
    ${pinDotsHTML()}
    ${pinPadHTML()}
    <div class="pin-msg">${S.pinError}</div>
    <button class="pin-skip" onclick="skipPin()">Skip â€” I'll set one later</button>
  </div>`;
}

function pinEnterHTML() {
  return `<div class="pin-wrap fadeIn">
    <div class="pin-logo">ğŸ”’</div>
    <h1>CustodyLog</h1>
    <p class="sub">Enter your PIN to unlock</p>
    ${pinDotsHTML()}
    ${pinPadHTML()}
    <div class="pin-msg">${S.pinError}</div>
    <button class="pin-skip" onclick="resetAll()">Forgot PIN? Reset app</button>
  </div>`;
}

function pinDotsHTML() {
  let h = '<div class="pin-dots">';
  for (let i = 0; i < 4; i++) {
    const filled = i < S.pinDigits.length;
    const err = S.pinError ? ' error' : '';
    h += `<div class="pin-dot${filled ? ' filled' : ''}${err}"></div>`;
  }
  return h + '</div>';
}

function pinPadHTML() {
  const keys = [1,2,3,4,5,6,7,8,9,'','0','âŒ«'];
  let h = '<div class="pin-pad">';
  keys.forEach(k => {
    if (k === '') h += '<div class="pin-key empty"></div>';
    else if (k === 'âŒ«') h += `<div class="pin-key fn" onclick="pinBack()">âŒ«</div>`;
    else h += `<div class="pin-key" onclick="pinTap(${k})">${k}</div>`;
  });
  return h + '</div>';
}

function pinTap(n) {
  if (S.pinDigits.length >= 4) return;
  S.pinError = '';
  S.pinDigits.push(n);
  render();
  if (S.pinDigits.length === 4) {
    setTimeout(() => {
      if (S.screen === 'pin_create') handlePinCreate();
      else handlePinEnter();
    }, 200);
  }
}

function pinBack() {
  S.pinDigits.pop();
  S.pinError = '';
  render();
}

function handlePinCreate() {
  const code = S.pinDigits.join('');
  if (S.pinPhase === 'first') {
    S.pinFirst = [...S.pinDigits];
    S.pinDigits = [];
    S.pinPhase = 'confirm';
    render();
  } else {
    if (code === S.pinFirst.join('')) {
      LS.setPin(code);
      LS.setSeen();
      S.pinDigits = [];
      S.screen = 'app';
      toast('ğŸ”’ PIN set successfully');
      render();
    } else {
      S.pinError = 'PINs don\'t match. Try again.';
      S.pinDigits = [];
      S.pinPhase = 'first';
      S.pinFirst = [];
      render();
    }
  }
}

function handlePinEnter() {
  const code = S.pinDigits.join('');
  if (code === LS.pin()) {
    S.pinDigits = [];
    S.screen = 'app';
    render();
  } else {
    S.pinError = 'Wrong PIN. Try again.';
    S.pinDigits = [];
    render();
    // shake animation
    const dots = document.querySelector('.pin-dots');
    if (dots) dots.classList.add('shake');
  }
}

function skipPin() {
  LS.setSeen();
  S.screen = 'app';
  render();
}

function resetAll() {
  if (!confirm('This will delete ALL data and reset the app. Are you sure?')) return;
  localStorage.clear();
  S.entries = [];
  S.pinDigits = [];
  S.screen = 'pin_create';
  S.pinPhase = 'first';
  toast('App reset');
  render();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  APP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function appHTML() {
  return `
    ${headerHTML()}
    ${tabsHTML()}
    <div class="content">
      ${S.tab === 'new' ? (S.page === 'categories' ? categoriesHTML() : formHTML()) : ''}
      ${S.tab === 'log' ? logHTML() : ''}
      ${S.tab === 'export' ? exportHTML() : ''}
    </div>
    ${S.viewing ? modalHTML() : ''}`;
}

function headerHTML() {
  return `<div class="header">
    <h1><span>ğŸ›¡ï¸</span> CustodyLog</h1>
    <div class="hdr-btns">
      <button class="ibtn" onclick="lockApp()" title="Lock">ğŸ”’</button>
    </div>
  </div>`;
}

function tabsHTML() {
  const tt = [
    {id:'new', label: S.page==='form' ? 'â† Back' : '+ New Entry'},
    {id:'log', label:`Log (${S.entries.length})`},
    {id:'export', label:'Export'},
  ];
  return `<div class="tabs">
    ${tt.map(t => `<button class="tab ${S.tab===t.id?'on':''}" onclick="setTab('${t.id}')">${t.label}</button>`).join('')}
  </div>`;
}

function setTab(t) {
  if (t === 'new' && S.tab === 'new' && S.page === 'form') {
    S.page = 'categories';
    render();
    return;
  }
  S.tab = t;
  if (t === 'new') S.page = 'categories';
  render();
}

// â”€â”€ Categories Page â”€â”€
function categoriesHTML() {
  const groups = {};
  CATS.forEach(c => { if (!groups[c.g]) groups[c.g] = []; groups[c.g].push(c); });
  let h = '';
  if (!LS.pin()) {
    h += `<div class="note note-info"><span class="ni">ğŸ”’</span><span>Your data is stored only on this device. Tap the lock icon to set a PIN.</span></div>`;
  }
  for (const [g, cats] of Object.entries(groups)) {
    h += `<div class="grp-label">${GROUPS[g]}</div><div class="cat-grid">`;
    cats.forEach(c => {
      h += `<button class="cat-btn" onclick="pickCat('${c.id}')"><span class="ci">${c.icon}</span>${c.label}</button>`;
    });
    h += '</div>';
  }
  return h;
}

function pickCat(id) {
  S.cat = id;
  S.page = 'form';
  const n = nowDT();
  if (!S.editId) { S.date = n.date; S.time = n.time; }
  render();
  window.scrollTo(0, 0);
}

// â”€â”€ Detail Form Page â”€â”€
function formHTML() {
  const cat = CATS.find(c => c.id === S.cat);
  return `<div class="form-page slideRight">
    <div class="back-bar" onclick="S.page='categories';render();">
      <span class="arrow">â†</span>
      <span class="cat-tag">${cat ? cat.icon : ''} ${cat ? cat.label : ''}</span>
    </div>

    <div class="fgroup">
      <label class="flabel">Severity</label>
      <div class="sev-row">
        ${SEVS.map(s => `<button class="sev-btn ${S.severity===s.id?s.cls:''}" onclick="S.severity='${s.id}';render();">${s.label}</button>`).join('')}
      </div>
    </div>

    <div class="fgroup">
      <label class="flabel">Date & Time</label>
      <div class="row">
        <input type="date" class="finput" value="${S.date}" onchange="S.date=this.value">
        <input type="time" class="finput" value="${S.time}" onchange="S.time=this.value">
      </div>
    </div>

    <div class="fgroup">
      <label class="flabel">What happened? (Be factual & specific)</label>
      <textarea class="ftextarea" placeholder="Describe exactly what was said or done. Stick to what you saw, heard, or received. Avoid opinions â€” let the facts speak."
        oninput="S.desc=this.value">${S.desc}</textarea>
    </div>

    <div class="fgroup">
      <label class="flabel">Location (optional)</label>
      <input type="text" class="finput" placeholder="Where did this happen?" value="${esc(S.location)}" oninput="S.location=this.value">
    </div>

    <div class="fgroup">
      <label class="flabel">Witnesses (optional)</label>
      <input type="text" class="finput" placeholder="Names of anyone who saw or heard" value="${esc(S.witnesses)}" oninput="S.witnesses=this.value">
    </div>

    <div class="chk-row" onclick="S.kidsThere=!S.kidsThere;render();">
      <input type="checkbox" ${S.kidsThere?'checked':''} tabindex="-1">
      <label>Children were present / involved</label>
    </div>
    ${S.kidsThere ? `<div class="fgroup" style="margin-top:0">
      <input type="text" class="finput" placeholder="Which children? (names/ages)" value="${esc(S.kidsNames)}" oninput="S.kidsNames=this.value">
    </div>` : ''}

    <div class="media-section">
      <label class="flabel">Attachments (optional)</label>
      <div class="media-btns">
        <button class="media-btn" onclick="addMedia('photo')"><span class="mi">ğŸ“·</span> Photo</button>
        <button class="media-btn" onclick="addMedia('video')"><span class="mi">ğŸ¥</span> Video</button>
        <button class="media-btn" onclick="addMedia('audio')"><span class="mi">ğŸ™ï¸</span> Audio</button>
        <button class="media-btn" onclick="addMedia('file')"><span class="mi">ğŸ“</span> File</button>
      </div>
      ${S.media.length ? `<div class="media-list">
        ${S.media.map((m, i) => `<div class="media-item slideUp">
          <div class="mthumb">${mediaThumbnail(m)}</div>
          <div class="minfo">
            <div class="mname">${esc(m.name)}</div>
            <div class="msize">${fmtSize(m.size)}</div>
          </div>
          <button class="mrem" onclick="removeMedia(${i})">Ã—</button>
        </div>`).join('')}
      </div>` : ''}
    </div>

    <button class="pbtn" onclick="saveEntry()" ${!S.desc.trim()?'disabled':''}>${S.editId ? 'ğŸ’¾ Update Entry' : 'ğŸ’¾ Save Entry'}</button>
    ${S.editId ? `<button class="sbtn" onclick="cancelEdit()">Cancel</button>` : ''}
  </div>`;
}

// â”€â”€ Media â”€â”€
function addMedia(type) {
  const inputMap = { photo:'photoInput', video:'videoInput', audio:'audioInput', file:'fileInput' };
  const el = document.getElementById(inputMap[type]);
  el.value = '';
  el.onchange = (e) => {
    const file = e.target.files[0];
    if (!file) return;
    if (file.size > 50 * 1024 * 1024) { toast('âŒ File too large (50MB max)'); return; }
    const reader = new FileReader();
    reader.onload = (ev) => {
      S.media.push({
        name: file.name,
        type: file.type,
        size: file.size,
        data: ev.target.result
      });
      render();
      toast('ğŸ“ File attached');
    };
    reader.readAsDataURL(file);
  };
  el.click();
}

function removeMedia(i) { S.media.splice(i, 1); render(); }

function mediaThumbnail(m) {
  if (m.type.startsWith('image/')) return `<img src="${m.data}" alt="">`;
  if (m.type.startsWith('video/')) return 'ğŸ¥';
  if (m.type.startsWith('audio/')) return 'ğŸ™ï¸';
  return 'ğŸ“';
}

function fmtSize(b) {
  if (b < 1024) return b + ' B';
  if (b < 1024*1024) return (b/1024).toFixed(1) + ' KB';
  return (b/(1024*1024)).toFixed(1) + ' MB';
}

// â”€â”€ Save â”€â”€
function saveEntry() {
  if (!S.desc.trim() || !S.cat) return;
  const n = nowDT();
  const entry = {
    id: S.editId || genId(),
    category: S.cat,
    severity: S.severity,
    description: S.desc.trim(),
    date: S.date || n.date,
    time: S.time || n.time,
    location: S.location.trim(),
    witnesses: S.witnesses.trim(),
    kidsThere: S.kidsThere,
    kidsNames: S.kidsNames.trim(),
    media: S.media.map(m => ({name:m.name, type:m.type, size:m.size, data:m.data})),
    createdAt: S.editId ? (S.entries.find(e=>e.id===S.editId)||{}).createdAt || new Date().toISOString() : new Date().toISOString(),
    updatedAt: new Date().toISOString(),
  };

  if (S.editId) {
    const idx = S.entries.findIndex(e => e.id === S.editId);
    if (idx >= 0) S.entries[idx] = entry;
  } else {
    S.entries.push(entry);
  }

  LS.save(S.entries);
  toast(S.editId ? 'âœ… Entry updated' : 'âœ… Entry saved');
  resetForm();
  S.tab = 'log';
  S.page = 'categories';
  render();
}

function resetForm() {
  S.cat = ''; S.severity = 'medium'; S.desc = ''; S.date = ''; S.time = '';
  S.location = ''; S.witnesses = ''; S.kidsThere = false; S.kidsNames = '';
  S.media = []; S.editId = null;
}

function cancelEdit() { resetForm(); S.page = 'categories'; render(); }

// â”€â”€ Log â”€â”€
function logHTML() {
  let list = [...S.entries].sort((a,b) => new Date(b.date+'T'+b.time) - new Date(a.date+'T'+a.time));
  if (S.search) {
    const q = S.search.toLowerCase();
    list = list.filter(e => e.description.toLowerCase().includes(q) || (e.witnesses||'').toLowerCase().includes(q) || (e.location||'').toLowerCase().includes(q) || catLabel(e.category).toLowerCase().includes(q));
  }
  if (S.filter !== 'all') list = list.filter(e => e.category === S.filter);
  const usedCats = [...new Set(S.entries.map(e => e.category))];

  return `
    <div class="search-bar"><span class="si">ğŸ”</span>
      <input type="text" placeholder="Search entries..." value="${esc(S.search)}" oninput="S.search=this.value;render();">
    </div>
    <div class="fbar">
      <button class="fchip ${S.filter==='all'?'on':''}" onclick="S.filter='all';render();">All (${S.entries.length})</button>
      ${usedCats.map(cid => {
        const c = CATS.find(x=>x.id===cid);
        const cnt = S.entries.filter(e=>e.category===cid).length;
        return `<button class="fchip ${S.filter===cid?'on':''}" onclick="S.filter='${cid}';render();">${c?c.icon:''} ${c?c.label:cid} (${cnt})</button>`;
      }).join('')}
    </div>
    ${list.length === 0 ? `<div class="empty"><div class="ei">ğŸ“‹</div>
      <h3>${S.entries.length===0?'No entries yet':'No matching entries'}</h3>
      <p>${S.entries.length===0?'Tap "+ New Entry" to log your first incident':'Try adjusting your search or filter'}</p></div>`
    : list.map(e => entryCardHTML(e)).join('')}`;
}

function entryCardHTML(e) {
  const c = CATS.find(x => x.id === e.category);
  const hasMed = e.media && e.media.length > 0;
  return `<div class="ecard" onclick="viewEntry('${e.id}')">
    <div class="ehead">
      <div class="ecat" style="color:${e.severity==='critical'||e.severity==='high'?'var(--rd)':e.severity==='medium'?'var(--yw)':'var(--gn)'}">${c?c.icon:'ğŸ“'} ${c?c.label:e.category}</div>
      <span class="esev sev-${e.severity}">${e.severity}</span>
    </div>
    <div class="edesc">${truncate(e.description, 150)}</div>
    <div class="emeta">
      <span>ğŸ“… ${fmtDate(e.date)}</span>
      <span>ğŸ• ${fmtTime(e.time)}</span>
      ${e.location?`<span>ğŸ“ ${truncate(e.location,25)}</span>`:''}
    </div>
    ${(e.kidsThere || e.witnesses || hasMed) ? `<div class="ebadges">
      ${e.kidsThere?`<span class="badge badge-rd">Children Present</span>`:''}
      ${e.witnesses?`<span class="badge badge-ac">Witnessed</span>`:''}
      ${hasMed?`<span class="badge badge-gn">${e.media.length} File${e.media.length>1?'s':''}</span>`:''}
    </div>` : ''}
  </div>`;
}

function viewEntry(id) { S.viewing = S.entries.find(e=>e.id===id)||null; render(); }

function modalHTML() {
  const e = S.viewing;
  if (!e) return '';
  const c = CATS.find(x=>x.id===e.category);
  const hasMed = e.media && e.media.length > 0;
  return `<div class="modal-bg open" onclick="closeModal(event)"><div class="modal">
    <div class="modal-handle"></div>
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h2>${c?c.icon:''} ${c?c.label:e.category}</h2>
      <span class="esev sev-${e.severity}">${e.severity}</span>
    </div>
    <div class="detail-row"><div class="dl">Date & Time</div><div class="dv">${fmtDate(e.date)} at ${fmtTime(e.time)}</div></div>
    ${e.location?`<div class="detail-row"><div class="dl">Location</div><div class="dv">${esc(e.location)}</div></div>`:''}
    <div class="detail-row"><div class="dl">Description</div><div class="dv">${esc(e.description)}</div></div>
    ${e.witnesses?`<div class="detail-row"><div class="dl">Witnesses</div><div class="dv">${esc(e.witnesses)}</div></div>`:''}
    ${e.kidsThere?`<div class="detail-row"><div class="dl">Children Present</div><div class="dv">Yes${e.kidsNames?' â€” '+esc(e.kidsNames):''}</div></div>`:''}
    ${hasMed ? `<div class="detail-row"><div class="dl">Attachments (${e.media.length})</div>
      <div class="modal-media">${e.media.map(m => {
        if (m.type.startsWith('image/')) return `<div class="mm" onclick="openMedia('${m.data}')"><img src="${m.data}"></div>`;
        if (m.type.startsWith('video/')) return `<div class="mm"><video src="${m.data}" controls style="width:100%;height:100%;object-fit:cover"></video></div>`;
        if (m.type.startsWith('audio/')) return `<div class="mm" style="width:140px"><audio src="${m.data}" controls style="width:100%"></audio></div>`;
        return `<div class="mm">ğŸ“</div>`;
      }).join('')}</div></div>` : ''}
    <div class="detail-id">ID: ${e.id} | Logged: ${new Date(e.createdAt).toLocaleString()}</div>
    <div class="modal-actions">
      <button class="sbtn" onclick="editEntry('${e.id}')">âœï¸ Edit</button>
      <button class="dbtn" onclick="deleteEntry('${e.id}')">ğŸ—‘ï¸ Delete</button>
    </div>
  </div></div>`;
}

function closeModal(ev) { if (ev.target.classList.contains('modal-bg')) { S.viewing = null; render(); } }

function openMedia(data) {
  const w = window.open();
  w.document.write(`<img src="${data}" style="max-width:100%;height:auto;">`);
}

function editEntry(id) {
  const e = S.entries.find(x=>x.id===id);
  if (!e) return;
  S.editId = e.id; S.cat = e.category; S.severity = e.severity;
  S.desc = e.description; S.date = e.date; S.time = e.time;
  S.location = e.location||''; S.witnesses = e.witnesses||'';
  S.kidsThere = e.kidsThere||false; S.kidsNames = e.kidsNames||'';
  S.media = (e.media||[]).map(m => ({...m}));
  S.viewing = null; S.tab = 'new'; S.page = 'form';
  render(); toast('âœï¸ Editing entry');
}

function deleteEntry(id) {
  if (!confirm('Delete this entry permanently?')) return;
  S.entries = S.entries.filter(e=>e.id!==id);
  LS.save(S.entries);
  S.viewing = null; toast('ğŸ—‘ï¸ Entry deleted'); render();
}

function lockApp() {
  if (LS.pin()) {
    S.screen = 'pin_enter'; S.pinDigits = []; S.pinError = ''; render();
  } else {
    S.screen = 'pin_create'; S.pinDigits = []; S.pinPhase = 'first'; S.pinError = ''; render();
  }
}

// â”€â”€ Export â”€â”€
function exportHTML() {
  const t = S.entries.length;
  const sc = {critical:0,high:0,medium:0,low:0};
  S.entries.forEach(e => sc[e.severity]++);
  return `
    <div class="stats">
      <div class="stat"><div class="num">${t}</div><div class="lbl">Total</div></div>
      <div class="stat"><div class="num" style="color:var(--rd)">${sc.critical+sc.high}</div><div class="lbl">High+Critical</div></div>
      <div class="stat"><div class="num">${new Set(S.entries.map(e=>e.category)).size}</div><div class="lbl">Categories</div></div>
      <div class="stat"><div class="num">${S.entries.filter(e=>e.kidsThere).length}</div><div class="lbl">Kids Present</div></div>
    </div>
    <div class="grp-label">ğŸ“¤ Export Options</div>
    <div class="xcard" onclick="exportReport()"><div class="xi">ğŸ“„</div><div><h3>Attorney-Ready Report</h3><p>Formatted HTML â€” print or save as PDF</p></div></div>
    <div class="xcard" onclick="exportCSV()"><div class="xi">ğŸ“Š</div><div><h3>Spreadsheet (CSV)</h3><p>For Excel or Google Sheets</p></div></div>
    <div class="xcard" onclick="exportJSON()"><div class="xi">ğŸ’¾</div><div><h3>Full Backup (JSON)</h3><p>Complete data backup with attachments</p></div></div>
    <div class="xcard" onclick="importJSON()"><div class="xi">ğŸ“¥</div><div><h3>Restore from Backup</h3><p>Import a previous backup file</p></div></div>
    <div class="disclaimer"><strong>âš ï¸ Important:</strong> Data is stored locally on your device only. No data is sent to any server. <strong>Always export backups regularly.</strong> Clearing browser data will delete all entries. This app is not legal advice â€” consult your attorney.</div>`;
}

function exportReport() {
  if (!S.entries.length) { toast('No entries'); return; }
  const sorted = [...S.entries].sort((a,b)=>new Date(a.date+'T'+a.time)-new Date(b.date+'T'+b.time));
  const now = new Date().toLocaleString();
  let h = `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Custody Incident Log â€” ${now}</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Source+Sans+3:wght@400;600;700&display=swap');
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Source Sans 3',Arial,sans-serif;max-width:800px;margin:0 auto;padding:40px 30px;color:#1a1a1a;font-size:14px;line-height:1.6}
@media print{body{padding:20px;font-size:12px}.no-print{display:none}.entry{break-inside:avoid}}
h1{font-size:22px;margin-bottom:4px}
.sub{color:#666;font-size:13px;margin-bottom:20px}
.conf{background:#fff3cd;border:1px solid #ffc107;padding:10px 14px;border-radius:6px;margin-bottom:20px;font-size:12px;font-weight:600;color:#856404}
.summary{background:#f8f9fa;border:1px solid #dee2e6;border-radius:6px;padding:16px;margin-bottom:20px}
.summary h2{font-size:14px;margin-bottom:10px;text-transform:uppercase;letter-spacing:1px;color:#495057}
.sg{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
.si{text-align:center}.si .n{font-size:24px;font-weight:700}.si .l{font-size:11px;color:#666;text-transform:uppercase}
.monthh{font-size:16px;margin:24px 0 12px;padding-bottom:6px;border-bottom:2px solid #dee2e6}
.entry{border:1px solid #dee2e6;border-radius:6px;padding:16px;margin-bottom:12px}
.eh{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:6px}
.ec{font-weight:700;font-size:13px;text-transform:uppercase;letter-spacing:.5px}
.es{font-size:11px;font-weight:700;padding:2px 8px;border-radius:12px;text-transform:uppercase}
.s-critical{background:#f8d7da;color:#842029}.s-high{background:#ffe5d0;color:#984c0c}
.s-medium{background:#fff3cd;color:#664d03}.s-low{background:#d1e7dd;color:#0f5132}
.ed{font-size:13px;color:#495057;margin-bottom:6px}
.edesc{font-size:14px;line-height:1.7;margin-bottom:8px;white-space:pre-wrap}
.edet{font-size:12px;color:#666}
.edet span{margin-right:14px}
.cf{color:#dc3545;font-weight:600}
.att{margin-top:8px}.att img{max-width:200px;max-height:150px;border-radius:4px;margin:4px 4px 4px 0}
.eid{font-size:10px;color:#aaa;margin-top:8px;font-family:monospace}
.footer{margin-top:32px;padding-top:16px;border-top:1px solid #dee2e6;font-size:11px;color:#999;text-align:center}
.pbtn{position:fixed;bottom:30px;right:30px;background:#0d6efd;color:#fff;border:none;padding:14px 28px;border-radius:8px;font-size:15px;font-weight:600;cursor:pointer;box-shadow:0 4px 12px rgba(0,0,0,.3)}
</style></head><body>
<h1>ğŸ“‹ Custody Incident Documentation Log</h1>
<div class="sub">Generated: ${now} | Total Entries: ${sorted.length}</div>
<div class="conf">âš ï¸ PRIVILEGED & CONFIDENTIAL â€” Prepared for attorney review.</div>
<div class="summary"><h2>Summary</h2><div class="sg">
<div class="si"><div class="n">${sorted.length}</div><div class="l">Total</div></div>
<div class="si"><div class="n" style="color:#dc3545">${sorted.filter(e=>e.severity==='critical').length}</div><div class="l">Critical</div></div>
<div class="si"><div class="n" style="color:#e85d04">${sorted.filter(e=>e.severity==='high').length}</div><div class="l">High</div></div>
<div class="si"><div class="n">${sorted.filter(e=>e.kidsThere).length}</div><div class="l">Kids Present</div></div>
<div class="si"><div class="n">${sorted.filter(e=>e.witnesses).length}</div><div class="l">Witnessed</div></div>
<div class="si"><div class="n">${sorted.filter(e=>e.media&&e.media.length).length}</div><div class="l">W/ Attachments</div></div>
</div></div>`;

  const months = {};
  sorted.forEach(e => { const m = e.date.slice(0,7); if (!months[m]) months[m] = []; months[m].push(e); });

  for (const [month, entries] of Object.entries(months)) {
    const d = new Date(month+'-01');
    h += `<h2 class="monthh">${d.toLocaleDateString('en-US',{year:'numeric',month:'long'})} (${entries.length})</h2>`;
    entries.forEach(e => {
      const c = CATS.find(x=>x.id===e.category);
      h += `<div class="entry">
        <div class="eh"><div class="ec">${c?c.icon+' '+c.label:e.category}</div><span class="es s-${e.severity}">${e.severity}</span></div>
        <div class="ed">ğŸ“… ${fmtDate(e.date)} at ${fmtTime(e.time)}</div>
        <div class="edesc">${escH(e.description)}</div>
        <div class="edet">
          ${e.location?`<span>ğŸ“ ${escH(e.location)}</span>`:''}
          ${e.witnesses?`<span>ğŸ‘ï¸ ${escH(e.witnesses)}</span>`:''}
          ${e.kidsThere?`<span class="cf">âš ï¸ Children${e.kidsNames?' â€” '+escH(e.kidsNames):''}</span>`:''}
        </div>
        ${e.media&&e.media.length?`<div class="att">${e.media.filter(m=>m.type.startsWith('image/')).map(m=>`<img src="${m.data}">`).join('')}
          ${e.media.filter(m=>!m.type.startsWith('image/')).map(m=>`<span style="display:inline-block;padding:4px 8px;background:#e9ecef;border-radius:4px;font-size:12px;margin:4px 4px 0 0;">ğŸ“ ${escH(m.name)}</span>`).join('')}
        </div>`:''} 
        <div class="eid">ID: ${e.id} | Logged: ${new Date(e.createdAt).toLocaleString()}</div>
      </div>`;
    });
  }

  h += `<div class="footer"><p>Generated by CustodyLog | ${now}</p><p>Entries recorded by user at times indicated. IDs and timestamps are system-generated.</p></div>
  <button class="pbtn no-print" onclick="window.print()">ğŸ–¨ï¸ Print / Save as PDF</button></body></html>`;
  downloadBlob(h,'text/html',`CustodyLog_Report_${new Date().toISOString().slice(0,10)}.html`);
  toast('ğŸ“„ Report downloaded');
}

function exportCSV() {
  if (!S.entries.length) { toast('No entries'); return; }
  const sorted = [...S.entries].sort((a,b)=>new Date(a.date+'T'+a.time)-new Date(b.date+'T'+b.time));
  const hdr = ['Date','Time','Category','Severity','Description','Location','Witnesses','Children Present','Children Names','Attachments','Entry ID','Created'];
  const rows = sorted.map(e => [e.date,e.time,catLabel(e.category),e.severity,
    '"'+(e.description||'').replace(/"/g,'""')+'"',
    '"'+(e.location||'').replace(/"/g,'""')+'"',
    '"'+(e.witnesses||'').replace(/"/g,'""')+'"',
    e.kidsThere?'Yes':'No','"'+(e.kidsNames||'').replace(/"/g,'""')+'"',
    (e.media||[]).length, e.id, e.createdAt]);
  downloadBlob([hdr.join(','),...rows.map(r=>r.join(','))].join('\n'),'text/csv',`CustodyLog_${new Date().toISOString().slice(0,10)}.csv`);
  toast('ğŸ“Š CSV downloaded');
}

function exportJSON() {
  if (!S.entries.length) { toast('No entries'); return; }
  downloadBlob(JSON.stringify({v:2,date:new Date().toISOString(),entries:S.entries},null,2),'application/json',`CustodyLog_Backup_${new Date().toISOString().slice(0,10)}.json`);
  toast('ğŸ’¾ Backup downloaded');
}

function importJSON() {
  const el = document.getElementById('importInput');
  el.value = '';
  el.onchange = (ev) => {
    const f = ev.target.files[0];
    if (!f) return;
    const r = new FileReader();
    r.onload = (e) => {
      try {
        const d = JSON.parse(e.target.result);
        if (d.entries && Array.isArray(d.entries)) {
          const ids = new Set(S.entries.map(x=>x.id));
          let added = 0;
          d.entries.forEach(entry => { if (!ids.has(entry.id)) { S.entries.push(entry); added++; } });
          LS.save(S.entries);
          toast(`ğŸ“¥ Imported ${added} entries`);
          render();
        } else toast('âŒ Invalid file');
      } catch { toast('âŒ Could not read file'); }
    };
    r.readAsText(f);
  };
  el.click();
}

// â”€â”€ Helpers â”€â”€
function genId() { return Date.now().toString(36)+Math.random().toString(36).slice(2,7); }
function catLabel(id) { const c=CATS.find(x=>x.id===id); return c?c.label:id; }
function truncate(s,n) { return s.length>n ? s.slice(0,n)+'â€¦' : s; }
function esc(s) { return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function escH(s) { const d=document.createElement('div');d.textContent=s;return d.innerHTML; }
function nowDT() { const d=new Date(); return {date:d.toISOString().split('T')[0],time:d.toTimeString().slice(0,5)}; }
function fmtDate(d) { try{return new Date(d+'T00:00:00').toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric',year:'numeric'});}catch{return d;} }
function fmtTime(t) { try{const[h,m]=t.split(':');const hr=parseInt(h);return`${hr>12?hr-12:hr||12}:${m} ${hr>=12?'PM':'AM'}`;}catch{return t;} }
function downloadBlob(c,t,f) { const b=new Blob([c],{type:t}),u=URL.createObjectURL(b),a=document.createElement('a');a.href=u;a.download=f;a.click();URL.revokeObjectURL(u); }
function toast(m) { const t=document.getElementById('toast');t.textContent=m;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2200); }

// â”€â”€ Boot â”€â”€
boot();

// Register SW
if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js').catch(()=>{});
</script>
</body>
</html>
